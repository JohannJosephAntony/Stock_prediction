<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Stock Prediction Model</title>
    <!-- Chart.js CDN for plotting graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Custom CSS for overall layout and styling */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex; /* Use flexbox for centering the container */
            justify-content: center;
            align-items: center;
        }

        .container {
            max-width: 1400px;
            width: 100%; /* Ensure container takes full width up to max-width */
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #3498db, #8e44ad);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.1em;
        }

        /* Styles for the navigation tabs */
        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 5px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #7f8c8d;
            margin: 0 5px;
        }

        .tab.active {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        /* Styles for tab content sections */
        .tab-content {
            display: none; /* Hidden by default */
        }

        .tab-content.active {
            display: block; /* Shown when active */
        }

        /* Styles for prediction controls (input fields, dropdown) */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        .control-group label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .control-group input, .control-group select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .control-group input:focus, .control-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Styles for buttons */
        .btn {
            padding: 12px 24px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
        }

        /* Prediction results cards (example, not used in current JS but kept for styling consistency) */
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .prediction-card {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .prediction-card:hover {
            transform: translateY(-5px);
        }

        .prediction-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .prediction-card .price {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .prediction-card .change {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .accuracy-card {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .accuracy-card:hover {
            transform: translateY(-5px);
        }

        .accuracy-card h3 {
            font-size: 1.2em;
            margin-bottom: 10px;
        }

        .accuracy-card .score {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }

        .risk-card {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(243, 156, 18, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .risk-card:hover {
            transform: translateY(-5px);
        }

        .sentiment-card {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(155, 89, 182, 0.3);
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .sentiment-card:hover {
            transform: translateY(-5px);
        }

        /* Chart container styles */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            position: relative;
            height: 300px; /* Default height for sub-charts */
            width: 100%;
        }

        #stockChart {
             height: 400px; /* Specific height for the main stock chart */
        }

        .chart-container h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        /* Loading indicator styles */
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Watchlist and analysis section styles */
        .indicators {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .indicator {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }

        .indicator:hover {
            transform: translateY(-3px);
        }

        .indicator h4 {
            font-size: 0.9em;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .indicator .value {
            font-size: 1.3em;
            font-weight: bold;
        }

        .status {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .alerts {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .alert-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .alert-item:last-child {
            margin-bottom: 0;
        }

        .watchlist-section {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .watchlist-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .watchlist-item:last-child {
            border-bottom: none;
        }

        .news-feed { /* This section is now removed from HTML but styles remain for completeness */
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .news-item { /* This section is now removed from HTML but styles remain for completeness */
            padding: 15px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
        }

        .news-item h4 { /* This section is now removed from HTML but styles remain for completeness */
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .news-item p { /* This section is now removed from HTML but styles remain for completeness */
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .news-item .time { /* This section is now removed from HTML but styles remain for completeness */
            color: #95a5a6;
            font-size: 0.8em;
            float: right;
        }

        .model-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .model-item {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .model-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .model-item .accuracy {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .results {
                grid-template-columns: 1fr;
            }

            .controls {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                margin: 2px 0;
            }
        }

        /* Heatmap styles (removed from HTML structure, but styles kept to avoid error) */
        .heatmap {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
            color: white;
            transition: transform 0.2s ease;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
        }

        /* Scenario analysis styles (removed from HTML structure, but styles kept to avoid error) */
        .scenario-analysis {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .scenario-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .confidence-meter {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .confidence-bar {
            width: 100px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #e74c3c, #f39c12, #2ecc71);
            transition: width 0.3s ease;
        }

        /* TradingView widget styles */
        .tradingview-widget-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* No news-toggle or custom-news specific styles needed as they are removed */
        .tradingview-news-widget {
            display: block; /* Always block as it's the only news source */
        }

        /* Styles for the new analysis tab content */
        .financial-metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-card {
            background: #ffffff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .metric-card h4 {
            font-size: 1em;
            color: #34495e;
            margin-bottom: 8px;
        }

        .metric-card .value {
            font-size: 1.5em;
            font-weight: bold;
            color: #2c3e50;
        }

        .company-profile {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .company-profile h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .company-profile p {
            color: #7f8c8d;
            line-height: 1.6;
            text-align: justify;
        }

        .industry-comparison {
            background: linear-gradient(135deg, #dbe4ff, #c3daff);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            color: #2c3e50;
        }

        .industry-comparison h3 {
            text-align: center;
            margin-bottom: 15px;
        }

        .industry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
        }

        .industry-item:last-child {
            border-bottom: none;
        }

        .industry-item strong {
            font-size: 1.1em;
        }

        .industry-item span {
            font-weight: bold;
        }

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 400px;
            text-align: center;
            position: relative;
        }

        .modal-close-btn {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-close-btn:hover,
        .modal-close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal input {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
        }

        .modal button {
            padding: 10px 20px;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .modal button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        /* Placeholder for Analysis tab when no stock is selected */
        .analysis-placeholder {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Advanced AI Stock Prediction Model</h1> <!-- Removed robot face -->
            <p>Professional-grade ML prediction system with watchlist tracking & risk analysis</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="tabs">
            <button class="tab" onclick="switchTab(event, 'prediction')">📈 Prediction</button>
            <button class="tab" onclick="switchTab(event, 'watchlist')">⭐ Watchlist</button> <!-- Changed to Watchlist -->
            <button class="tab" onclick="switchTab(event, 'analysis')">📊 Analysis</button>
            <button class="tab active" onclick="switchTab(event, 'news')">📰 News</button> <!-- News tab active by default -->
        </div>

        <!-- Prediction Tab Content -->
        <div id="prediction-tab" class="tab-content">
            <form id="predictionForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="stockSymbol" class="block text-gray-700 text-sm font-semibold mb-2">Stock Symbol (e.g., AAPL, GOOGL):</label>
                        <input type="text" id="stockSymbol" name="stockSymbol" placeholder="Enter stock symbol" required
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 ease-in-out text-gray-900">
                    </div>
                    <div>
                        <label for="modelType" class="block text-gray-700 text-sm font-semibold mb-2">AI Model Type</label>
                        <select id="modelType"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 ease-in-out text-gray-900">
                            <option value="xgboost">XGBoost (Ensemble)</option>
                            <option value="sklearn">Scikit-learn (Polynomial Regression)</option>
                            <option value="lightgbm">LightGBM (Ensemble)</option>
                            <option value="pytorch" selected>PyTorch (LSTM Deep Learning)</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-between gap-4 mt-4">
                    <button type="submit"
                            class="flex-1 bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-opacity-75">
                        Get Predictions & Charts
                    </button>
                    <button type="button" id="addToWatchlistBtn"
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                        Add to Watchlist
                    </button>
                </div>
            </form>

            <div id="loadingIndicator" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p id="loadingText">Fetching data, predicting with multiple models, and generating charts...</p>
            </div>

            <div id="resultContainer" class="mt-6 p-4 border border-gray-200 bg-gray-50 rounded-lg shadow-inner" style="display: none;">
                <h2 class="text-xl font-bold text-gray-800 mb-3">Analysis & Prediction Results:</h2>
                <p id="symbolOutput" class="text-gray-700 text-lg mb-1"></p>
                <p id="latestPriceOutput" class="text-gray-700 text-lg mb-1"></p>
                <p id="supportOutput" class="text-gray-700 text-lg mb-1"></p>
                <p id="resistanceOutput" class="text-gray-700 text-lg mb-1"></p>
                <p id="messageOutput" class="text-gray-600 text-xs mt-2 italic"></p>

                <h3 class="text-xl font-bold text-gray-700 mt-6 mb-2">Selected Model Predictions:</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-1">1-Day Prediction (for <span id="predictionDate1Day"></span>):</h4>
                        <p id="predictedPrice1DayOutput" class="text-gray-700 text-base"></p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-1">7-Day Prediction (for <span id="predictionDate7Day"></span>):</h4>
                        <p id="predictedPrice7DayOutput" class="text-gray-700 text-base"></p>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-1">30-Day Prediction (for <span id="predictionDate30Day"></span>):</h4>
                        <p id="predictedPrice30DayOutput" class="text-gray-700 text-base"></p>
                    </div>
                </div>

                <div class="chart-container" style="height: 400px;">
                    <canvas id="stockChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="macdChart"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="rsiChart"></canvas>
                </div>
            </div>

            <div id="errorContainer" class="mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" style="display: none;">
                <p id="errorMessage" class="font-semibold"></p>
            </div>
        </div>

        <!-- Watchlist Tab Content -->
        <div id="watchlist-tab" class="tab-content">
            <div class="watchlist-section">
                <h3>⭐ Your Watchlist</h3>
                <div id="watchlistItems">
                    <!-- Watchlist items will be dynamically added here -->
                    <p id="emptyWatchlistMessage" class="text-gray-600 text-center py-4">Your watchlist is currently empty. Add stocks from the Prediction tab!</p>
                </div>
            </div>

            <div class="chart-container">
                <h3>📊 Watchlist Performance</h3>
                <canvas id="portfolioChart"></canvas>
            </div>
        </div>

        <!-- Analysis Tab Content -->
        <div id="analysis-tab" class="tab-content">
            <h2 class="text-xl font-bold text-gray-800 mb-4 text-center">Fundamental Analysis</h2>

            <div id="analysisPlaceholder" class="analysis-placeholder">
                Please enter a stock symbol in the Prediction tab and click "Get Predictions & Charts" to view its analysis here.
            </div>

            <div id="companyAnalysisContent" style="display: none;">
                <div class="company-profile">
                    <h3>🏢 Company Profile</h3>
                    <p id="companyDescription">
                        <!-- Company description will be populated here -->
                    </p>
                </div>

                <div class="financial-metrics-grid">
                    <div class="metric-card">
                        <h4>P/E Ratio</h4>
                        <span class="value" id="peRatio">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>EPS (TTM)</h4>
                        <span class="value" id="epsTtm">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>Market Cap</h4>
                        <span class="value" id="marketCap">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>Dividend Yield</h4>
                        <span class="value" id="dividendYield">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>Beta</h4>
                        <span class="value" id="beta">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>52-Week High</h4>
                        <span class="value" id="fiftyTwoWeekHigh">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>52-Week Low</h4>
                        <span class="value" id="fiftyTwoWeekLow">N/A</span>
                    </div>
                    <div class="metric-card">
                        <h4>Average Volume</h4>
                        <span class="value" id="avgVolume">N/A</span>
                    </div>
                </div>

                <div class="industry-comparison">
                    <h3>📈 Industry Comparison (Conceptual)</h3>
                    <div class="industry-item">
                        <strong id="yourStockIndustry">Your Stock:</strong>
                        <span id="yourStockPE" style="color: #3498db;">P/E: N/A</span>
                        <span id="yourStockDivYield" style="color: #3498db;">Div Yield: N/A</span>
                    </div>
                    <div class="industry-item">
                        <strong>Industry Average:</strong>
                        <span style="color: #7f8c8d;">P/E: 25x</span>
                        <span style="color: #7f8c8d;">Div Yield: 0.8%</span>
                    </div>
                    <div class="industry-item">
                        <strong>Sector Leader (MSFT):</strong>
                        <span style="color: #2ecc71;">P/E: 35x</span>
                        <span style="color: #2ecc71;">Div Yield: 0.7%</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Tab Content (only TradingView News) -->
        <div id="news-tab" class="tab-content active">
            <div id="tradingview-news" class="tradingview-news-widget">
                <div class="tradingview-widget-container">
                    <div class="tradingview-widget-container__widget"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quantity Input Modal -->
    <div id="quantityModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeQuantityModal()">&times;</span>
            <h2>Add to Watchlist</h2>
            <p>Enter quantity for <strong id="modalStockSymbol"></strong>:</p>
            <input type="number" id="quantityInput" placeholder="Enter quantity" min="1" value="1">
            <button onclick="confirmAddToWatchlist()">Add</button>
            <button onclick="closeQuantityModal()" style="background: #e74c3c;">Cancel</button>
        </div>
    </div>

    <script>
        let stockChart = null;
        let macdChart = null;
        let rsiChart = null;
        let portfolioChart = null; // Used for watchlist performance chart
        let tradingViewNewsLoaded = false;
        let currentPredictedStockSymbol = null; // Store the last successfully predicted stock

        // In-memory watchlist array
        let watchlist = [];

        // Function to switch between tabs
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.querySelectorAll('.tabs .tab').forEach(tab => {
                tab.classList.remove('active');
            });

            const selectedTabContent = document.getElementById(tabName + '-tab');
            if (selectedTabContent) {
                selectedTabContent.style.display = 'block';
            }
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            }

            // Initialize tab-specific content (mock data/widgets)
            if (tabName === 'watchlist') {
                renderWatchlist(); // Render watchlist items and chart
            } else if (tabName === 'analysis') {
                updateAnalysisTab(); // Show analysis or placeholder
            } else if (tabName === 'news' && !tradingViewNewsLoaded) {
                 loadTradingViewNewsWidget();
                 tradingViewNewsLoaded = true;
            }
        }

        // --- Mock Data Generation Functions ---
        function generateStockData(symbol, days = 100) {
            const data = [];
            let price = Math.random() * 200 + 50;
            const baseVolatility = 0.02;

            for (let i = 0; i < days; i++) {
                const date = new Date();
                date.setDate(date.getDate() - (days - i));

                const trend = Math.sin(i / 20) * 0.001;
                const randomWalk = (Math.random() - 0.5) * baseVolatility;
                const volatility = Math.random() * 0.01;

                price = price * (1 + trend + randomWalk + volatility);
                price = Math.max(price, 10);

                data.push({
                    date: date,
                    price: parseFloat(price.toFixed(2)),
                    volume: Math.floor(Math.random() * 5000000) + 500000,
                    rsi: Math.random() * 100,
                    macd: (Math.random() - 0.5) * 5,
                    bollinger_upper: price * 1.05,
                    bollinger_lower: price * 0.95
                });
            }
            return data;
        }

        function calculateTechnicalIndicators(data) {
            const latest = data[data.length - 1];
            return {
                rsi: parseFloat((Math.random() * 40 + 30).toFixed(1)),
                macd: parseFloat(((Math.random() - 0.5) * 4).toFixed(2)),
                volatility: parseFloat((Math.random() * 3 + 0.5).toFixed(1)),
                trend: ['Bullish', 'Bearish', 'Neutral'][Math.floor(Math.random() * 3)],
                support: parseFloat((latest.price * (0.95 + Math.random() * 0.03)).toFixed(2)),
                resistance: parseFloat((latest.price * (1.02 + Math.random() * 0.03)).toFixed(2))
            };
        }

        function initializePortfolioChart() {
            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            if (portfolioChart) {
                portfolioChart.destroy();
            }

            const dates = Array.from({ length: 30 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (29 - i));
                return d.toISOString().split('T')[0];
            });
            const watchlistValue = [];
            let currentValue = 30000; // Starting value for mock portfolio
            if (watchlist.length > 0) {
                // If watchlist has items, make the performance a bit more dynamic
                currentValue = watchlist.reduce((sum, item) => sum + (item.quantity * item.currentPrice), 0);
            } else {
                currentValue = 0; // If watchlist is empty, value is 0
            }


            for(let i=0; i<30; i++) {
                currentValue = currentValue * (1 + (Math.random() - 0.5) * 0.015);
                watchlistValue.push(parseFloat(currentValue.toFixed(2)));
            }

            portfolioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: 'Watchlist Value ($)',
                        data: watchlistValue,
                        borderColor: 'rgba(155, 89, 182, 1)',
                        backgroundColor: 'rgba(155, 89, 182, 0.2)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Overall Watchlist Performance',
                            font: {
                                size: 18
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Value ($)'
                            },
                            beginAtZero: true // Ensure chart starts at 0 for watchlist if empty
                        }
                    }
                }
            });
        }

        function loadTradingViewNewsWidget() {
            const script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-timeline.js';
            script.async = true;
            script.innerHTML = JSON.stringify({
                "feedMode": "market",
                "isTransparent": false,
                "colorTheme": "light",
                "displayMode": "regular",
                "width": "100%",
                "height": "400px",
                "utm_medium": "widget_new",
                "utm_source": "yourwebsite.com"
            });
            const widgetContainer = document.querySelector(".tradingview-widget-container__widget");
            if (widgetContainer) {
                widgetContainer.innerHTML = ''; // Clear existing content
                widgetContainer.appendChild(script);
            } else {
                console.error("TradingView widget container not found.");
            }
        }

        // Function to populate financial metrics (mock data for now)
        function populateFinancialMetrics(symbol, currentPrice) {
            const companyDescriptionElem = document.getElementById('companyDescription');
            const peRatioElem = document.getElementById('peRatio');
            const epsTtmElem = document.getElementById('epsTtm');
            const marketCapElem = document.getElementById('marketCap');
            const dividendYieldElem = document.getElementById('dividendYield');
            const betaElem = document.getElementById('beta');
            const fiftyTwoWeekHighElem = document.getElementById('fiftyTwoWeekHigh');
            const fiftyTwoWeekLowElem = document.getElementById('fiftyTwoWeekLow');
            const avgVolumeElem = document.getElementById('avgVolume');
            const yourStockIndustryElem = document.getElementById('yourStockIndustry');
            const yourStockPEElem = document.getElementById('yourStockPE');
            const yourStockDivYieldElem = document.getElementById('yourStockDivYield');

            // Show content sections
            document.getElementById('analysisPlaceholder').style.display = 'none';
            document.getElementById('companyAnalysisContent').style.display = 'block';

            // Mock data based on symbol (can be expanded with more detailed mock data or real API calls)
            let description = "Detailed company profile will appear here after fetching data for the selected stock. This will include an overview of its business, industry, and strategic positioning.";
            let pe = "N/A";
            let eps = "N/A";
            let marketCap = "N/A";
            let dividend = "N/A";
            let betaVal = "N/A";
            let high52 = "N/A";
            let low52 = "N/A";
            let avgVol = "N/A";

            if (symbol === 'AAPL') {
                description = "Apple Inc. designs, manufactures, and markets smartphones, personal computers, tablets, wearables, and accessories worldwide. It also sells related services. It's known for its innovation in consumer electronics and digital services, with a strong brand presence.";
                pe = "28.5x";
                eps = "$6.13";
                marketCap = "$3.2T";
                dividend = "0.52%";
                betaVal = "1.25";
                high52 = "$220.00";
                low52 = "$165.00";
                avgVol = "75M";
            } else if (symbol === 'GOOGL') {
                description = "Alphabet Inc. is a multinational technology conglomerate holding company. It is known for its Google Search engine, cloud computing, advertising, and other technology services. It invests heavily in AI and innovative technologies.";
                pe = "25.0x";
                eps = "$5.50";
                marketCap = "$2.3T";
                dividend = "0.0%"; // Google typically doesn't pay dividends
                betaVal = "1.05";
                high52 = "$190.00";
                low52 = "$140.00";
                avgVol = "40M";
            } else if (symbol === 'TSLA') {
                description = "Tesla, Inc. designs, manufactures, and sells electric vehicles, battery energy storage from home to grid-scale, solar panels and related products and services. Its innovative approach to electric mobility and renewable energy has disrupted multiple industries.";
                pe = "55.0x";
                eps = "$4.20";
                marketCap = "$0.9T";
                dividend = "0.0%";
                betaVal = "2.00";
                high52 = "$300.00";
                low52 = "$180.00";
                avgVol = "100M";
            } else {
                description = `No specific detailed profile available for ${symbol}. This section would display comprehensive information if fetched from a real data source.`;
                pe = "N/A";
                eps = "N/A";
                marketCap = "N/A";
                dividend = "N/A";
                betaVal = "N/A";
                high52 = "N/A";
                low52 = "N/A";
                avgVol = "N/A";
            }

            companyDescriptionElem.textContent = description;
            peRatioElem.textContent = pe;
            epsTtmElem.textContent = eps;
            marketCapElem.textContent = marketCap;
            dividendYieldElem.textContent = dividend;
            betaElem.textContent = betaVal;
            fiftyTwoWeekHighElem.textContent = high52;
            fiftyTwoWeekLowElem.textContent = low52;
            avgVolumeElem.textContent = avgVol;

            // Update Industry Comparison for the selected stock
            yourStockIndustryElem.textContent = `Your Stock (${symbol}):`;
            yourStockPEElem.textContent = `P/E: ${pe}`;
            yourStockDivYieldElem.textContent = `Div Yield: ${dividend}`;
        }

        // Function to update the Analysis tab display based on whether a stock is predicted
        function updateAnalysisTab() {
            const analysisPlaceholder = document.getElementById('analysisPlaceholder');
            const companyAnalysisContent = document.getElementById('companyAnalysisContent');

            if (currentPredictedStockSymbol) {
                // If a stock has been predicted, populate its details
                populateFinancialMetrics(currentPredictedStockSymbol, 'MOCK_PRICE'); // Pass a mock price for now
            } else {
                // If no stock is predicted, show the placeholder and hide content
                analysisPlaceholder.style.display = 'block';
                companyAnalysisContent.style.display = 'none';
            }
        }


        // --- Watchlist Functions ---
        // Function to render the watchlist in the UI
        function renderWatchlist() {
            const watchlistItemsContainer = document.getElementById('watchlistItems');
            watchlistItemsContainer.innerHTML = ''; // Clear existing items

            if (watchlist.length === 0) {
                watchlistItemsContainer.innerHTML = '<p id="emptyWatchlistMessage" class="text-gray-600 text-center py-4">Your watchlist is currently empty. Add stocks from the Prediction tab!</p>';
            } else {
                watchlist.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'watchlist-item';
                    itemDiv.innerHTML = `
                        <div>
                            <strong>${item.symbol}</strong>
                            <span style="color: #7f8c8d;">${item.quantity} shares</span>
                            <br>
                            <span style="color: #7f8c8d;">Avg Buy: $${item.buyPrice.toFixed(2)}</span>
                        </div>
                        <div>
                            <span style="color: ${item.currentPrice >= item.buyPrice ? '#2ecc71' : '#e74c3c'};">$${(item.quantity * item.currentPrice).toFixed(2)}</span>
                            <span style="color: ${item.currentPrice >= item.buyPrice ? '#2ecc71' : '#e74c3c'};">${(((item.currentPrice - item.buyPrice) / item.buyPrice) * 100).toFixed(2)}%</span>
                            <button class="ml-4 px-3 py-1 bg-red-500 hover:bg-red-600 text-white rounded-md text-sm transition duration-200" onclick="removeWatchlistItem('${item.symbol}')">Remove</button>
                        </div>
                    `;
                    watchlistItemsContainer.appendChild(itemDiv);
                });
            }
            initializePortfolioChart(); // Update the watchlist performance chart
        }

        // Function to remove an item from the watchlist
        function removeWatchlistItem(symbolToRemove) {
            watchlist = watchlist.filter(item => item.symbol !== symbolToRemove);
            renderWatchlist(); // Re-render the watchlist
        }

        // Function to show the quantity input modal
        function showQuantityModal(symbol) {
            const modal = document.getElementById('quantityModal');
            document.getElementById('modalStockSymbol').textContent = symbol;
            document.getElementById('quantityInput').value = 1; // Default quantity
            modal.style.display = 'flex'; // Use flex to center
        }

        // Function to close the quantity input modal
        function closeQuantityModal() {
            document.getElementById('quantityModal').style.display = 'none';
        }

        // Function to confirm adding to watchlist from modal
        function confirmAddToWatchlist() {
            const symbol = document.getElementById('modalStockSymbol').textContent;
            const quantity = parseInt(document.getElementById('quantityInput').value);

            if (isNaN(quantity) || quantity <= 0) {
                // You could add a more user-friendly error message here
                alert("Please enter a valid quantity (a positive number)."); // Using alert as a simple example, replace with custom modal
                return;
            }

            // Get the latest price from the prediction results for buy price
            const latestPriceElement = document.getElementById('latestPriceOutput');
            let latestPrice = parseFloat(latestPriceElement.textContent.replace('Latest Close Price: $', ''));

            if (isNaN(latestPrice)) {
                // Fallback or error if latest price isn't available from prediction
                latestPrice = 100 + Math.random() * 50; // Mock price if not predicted
                alert("Could not get latest price. Using a mock price for watchlist addition.");
            }

            // Check if stock is already in watchlist
            const existingItemIndex = watchlist.findIndex(item => item.symbol === symbol);
            if (existingItemIndex > -1) {
                // Update existing item
                watchlist[existingItemIndex].quantity += quantity;
                // For simplicity, average buy price or just use latest, this is a decision point
                watchlist[existingItemIndex].buyPrice = (watchlist[existingItemIndex].buyPrice * (watchlist[existingItemIndex].quantity - quantity) + latestPrice * quantity) / watchlist[existingItemIndex].quantity;
                watchlist[existingItemIndex].currentPrice = latestPrice; // Update current price as well
            } else {
                // Add new item
                watchlist.push({
                    symbol: symbol,
                    quantity: quantity,
                    buyPrice: latestPrice, // Assuming buy price is the current latest close price
                    currentPrice: latestPrice // For current value calculation
                });
            }

            closeQuantityModal();
            renderWatchlist(); // Update the watchlist display

            // Optionally, switch to watchlist tab after adding
            // switchTab(null, 'watchlist');
        }


        // --- Main DOM Content Loaded Event Listener ---
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('predictionForm');
            const stockSymbolInput = document.getElementById('stockSymbol');
            const modelTypeSelect = document.getElementById('modelType');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const resultContainer = document.getElementById('resultContainer');
            const addToWatchlistBtn = document.getElementById('addToWatchlistBtn');

            // General Info Output elements
            const symbolOutput = document.getElementById('symbolOutput');
            const latestPriceOutput = document.getElementById('latestPriceOutput');
            const supportOutput = document.getElementById('supportOutput');
            const resistanceOutput = document.getElementById('resistanceOutput');
            const messageOutput = document.getElementById('messageOutput');

            // Prediction Date Output elements
            const predictionDate1Day = document.getElementById('predictionDate1Day');
            const predictionDate7Day = document.getElementById('predictionDate7Day');
            const predictionDate30Day = document.getElementById('predictionDate30Day');

            // Consolidated Prediction Output elements for the selected model
            const predictedPrice1DayOutput = document.getElementById('predictedPrice1DayOutput');
            const predictedPrice7DayOutput = document.getElementById('predictedPrice7DayOutput');
            const predictedPrice30DayOutput = document.getElementById('predictedPrice30DayOutput');

            const errorContainer = document.getElementById('errorContainer');
            const errorMessage = document.getElementById('errorMessage');

            // Chart Contexts for Chart.js
            const stockChartCtx = document.getElementById('stockChart').getContext('2d');
            const macdChartCtx = document.getElementById('macdChart').getContext('2d');
            const rsiChartCtx = document.getElementById('rsiChart').getContext('2d');

            // Helper function to show messages (errors or results)
            function showMessage(container, message, isError = false) {
                container.style.display = 'block';
                if (isError) {
                    container.classList.remove('bg-gray-50', 'border-gray-200');
                    container.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    errorMessage.textContent = message;
                } else {
                    container.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                    container.classList.add('bg-gray-50', 'border-gray-200');
                    // For success, content is set directly to outputs, so no message here
                }
            }

            // Helper function to hide all message containers and destroy charts
            function hideAllMessages() {
                loadingIndicator.style.display = 'none';
                resultContainer.style.display = 'none';
                errorContainer.style.display = 'none';
                if (stockChart) stockChart.destroy();
                if (macdChart) macdChart.destroy();
                if (rsiChart) rsiChart.destroy();
            }

            // Initial setup: Display the News tab and load TradingView widget by default
            document.querySelectorAll('.tab-content').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById('news-tab').style.display = 'block'; // Show News tab content
            document.querySelector('.tabs .tab[onclick*="news"]').classList.add('active'); // Set News tab button active

            // Load TradingView widget on initial page load (as it's now the only news source)
            if (!tradingViewNewsLoaded) {
                loadTradingViewNewsWidget();
                tradingViewNewsLoaded = true;
            }

            // Add event listener for "Add to Watchlist" button
            addToWatchlistBtn.addEventListener('click', () => {
                const symbol = stockSymbolInput.value.trim();
                if (symbol) {
                    showQuantityModal(symbol);
                } else {
                    // Provide feedback if no symbol is entered
                    showMessage(errorContainer, "Please enter a stock symbol in the Prediction tab first.", true);
                }
            });


            // Event listener for the prediction form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const stockSymbol = stockSymbolInput.value.trim();
                if (!stockSymbol) {
                    showMessage(errorContainer, "Please enter a stock symbol.", true);
                    return;
                }

                hideAllMessages(); // Clear previous results and hide error/loading messages
                loadingIndicator.style.display = 'block'; // Show loading indicator

                try {
                    const response = await fetch('http://127.0.0.1:5000/predict', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ symbol: stockSymbol }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        currentPredictedStockSymbol = stockSymbol; // Store the successfully predicted stock

                        // Populate General Info
                        symbolOutput.textContent = `Symbol: ${data.symbol}`;
                        latestPriceOutput.textContent = `Latest Close Price: $${data.latest_price.toFixed(2)}`;
                        supportOutput.textContent = `Support Level (30-day Low): $${data.support.toFixed(2)}`;
                        resistanceOutput.textContent = `Resistance Level (30-day High): $${data.resistance.toFixed(2)}`;
                        messageOutput.textContent = `Note: ${data.message}`;

                        // Update current price for any existing watchlist items
                        const watchlistIndex = watchlist.findIndex(item => item.symbol === stockSymbol);
                        if (watchlistIndex > -1) {
                            watchlist[watchlistIndex].currentPrice = data.latest_price;
                        }

                        // Populate Prediction Dates
                        predictionDate1Day.textContent = data.prediction_date_1day;
                        predictionDate7Day.textContent = data.prediction_date_7day;
                        predictionDate30Day.textContent = data.prediction_date_30day;

                        // Get the selected model and its name from the dropdown
                        const selectedModelKey = modelTypeSelect.value;
                        const selectedModelName = modelTypeSelect.options[modelTypeSelect.selectedIndex].text;

                        // Populate the CONSOLIDATED Prediction Outputs for the SELECTED model only
                        predictedPrice1DayOutput.textContent = `${selectedModelName}: $${data.predictions[selectedModelKey]['1day'].toFixed(2)}`;
                        predictedPrice7DayOutput.textContent = `${selectedModelName}: $${data.predictions[selectedModelKey]['7day'].toFixed(2)}`;
                        predictedPrice30DayOutput.textContent = `${selectedModelName}: $${data.predictions[selectedModelKey]['30day'].toFixed(2)}`;

                        // --- Charting ---

                        // Prepare data for Main Stock Price Chart
                        const dates = data.historical_data.map(item => item.date);
                        const prices = data.historical_data.map(item => item.price);

                        // Get the 1-day prediction for the SELECTED model to plot
                        const oneDayPredictionForChart = data.predictions[selectedModelKey]['1day'];

                        // Add the selected 1-day predicted price date to the chart's labels
                        const chartLabelsWithPrediction = [...dates, data.prediction_date_1day];

                        // Destroy existing stock chart if it exists before creating a new one
                        if (stockChart) {
                            stockChart.destroy();
                        }

                        // Create the main stock price chart
                        stockChart = new Chart(stockChartCtx, {
                            type: 'line',
                            data: {
                                labels: chartLabelsWithPrediction,
                                datasets: [
                                    {
                                        label: 'Historical Close Price',
                                        data: prices,
                                        borderColor: 'rgba(75, 192, 192, 1)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        borderWidth: 2,
                                        pointRadius: 3,
                                        fill: false,
                                        tension: 0.1
                                    },
                                    {
                                        label: `${selectedModelName} 1-Day Predicted Price`,
                                        data: [{ x: data.prediction_date_1day, y: oneDayPredictionForChart }],
                                        borderColor: 'rgba(255, 99, 132, 1)',
                                        backgroundColor: 'rgba(255, 99, 132, 0.5)',
                                        borderWidth: 4,
                                        pointRadius: 8,
                                        pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                                        type: 'scatter'
                                    },
                                    {
                                        label: 'Support Level',
                                        data: chartLabelsWithPrediction.map(() => data.support),
                                        borderColor: 'rgba(255, 206, 86, 1)',
                                        borderDash: [5, 5],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0
                                    },
                                    {
                                        label: 'Resistance Level',
                                        data: chartLabelsWithPrediction.map(() => data.resistance),
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        borderDash: [5, 5],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${data.symbol} Stock Price History & ${selectedModelName} 1-Day Prediction`,
                                        font: {
                                            size: 18
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'category',
                                        title: {
                                            display: true,
                                            text: 'Date'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Price ($)'
                                        },
                                        beginAtZero: false
                                    }
                                }
                            }
                        });

                        // Prepare data for MACD Chart
                        const macdLabels = data.chart_dates;
                        const macdLine = data.macd.macd;
                        const signalLine = data.macd.signal_line;
                        const histogram = data.macd.histogram;

                        // Destroy existing MACD chart if it exists
                        if (macdChart) {
                            macdChart.destroy();
                        }

                        // Create MACD Chart
                        macdChart = new Chart(macdChartCtx, {
                            type: 'bar',
                            data: {
                                labels: macdLabels,
                                datasets: [
                                    {
                                        label: 'MACD Histogram',
                                        data: histogram,
                                        backgroundColor: histogram.map(val => val >= 0 ? 'rgba(75, 192, 192, 0.6)' : 'rgba(255, 99, 132, 0.6)'),
                                        borderColor: histogram.map(val => val >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                                        borderWidth: 1,
                                        order: 2
                                    },
                                    {
                                        label: 'MACD Line',
                                        data: macdLine,
                                        type: 'line',
                                        borderColor: 'rgba(54, 162, 235, 1)',
                                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0.1,
                                        order: 1
                                    },
                                    {
                                        label: 'Signal Line',
                                        data: signalLine,
                                        type: 'line',
                                        borderColor: 'rgba(255, 206, 86, 1)',
                                        backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0.1,
                                        order: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${data.symbol} MACD`,
                                        font: {
                                            size: 18
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'category',
                                        title: {
                                            display: true,
                                            text: 'Date'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'Value'
                                        },
                                        beginAtZero: false
                                    }
                                }
                            }
                        });

                        // Prepare data for RSI Chart
                        const rsiLabels = data.chart_dates;
                        const rsiValues = data.rsi;

                        // Destroy existing RSI chart if it exists
                        if (rsiChart) {
                            rsiChart.destroy();
                        }

                        // Create RSI Chart
                        rsiChart = new Chart(rsiChartCtx, {
                            type: 'line',
                            data: {
                                labels: rsiLabels,
                                datasets: [
                                    {
                                        label: 'RSI',
                                        data: rsiValues,
                                        borderColor: 'rgba(153, 102, 255, 1)',
                                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                                        borderWidth: 2,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0.1
                                    },
                                    {
                                        label: 'Overbought (70)',
                                        data: rsiLabels.map(() => 70),
                                        borderColor: 'rgba(255, 0, 0, 0.7)',
                                        borderDash: [5, 5],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0
                                    },
                                    {
                                        label: 'Oversold (30)',
                                        data: rsiLabels.map(() => 30),
                                        borderColor: 'rgba(0, 128, 0, 0.7)',
                                        borderDash: [5, 5],
                                        borderWidth: 1,
                                        pointRadius: 0,
                                        fill: false,
                                        tension: 0
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: `${data.symbol} RSI`,
                                        font: {
                                            size: 18
                                        }
                                    }
                                },
                                scales: {
                                    x: {
                                        type: 'category',
                                        title: {
                                            display: true,
                                            text: 'Date'
                                        }
                                    },
                                    y: {
                                        title: {
                                            display: true,
                                            text: 'RSI Value'
                                        },
                                        min: 0,
                                        max: 100
                                    }
                                }
                            }
                        });

                        showMessage(resultContainer, '', false); // Show the results container
                    } else {
                        currentPredictedStockSymbol = null; // Clear if prediction failed
                        showMessage(errorContainer, data.error || "An unknown error occurred.", true);
                    }
                } catch (error) {
                    currentPredictedStockSymbol = null; // Clear if prediction failed
                    console.error('Error fetching prediction:', error);
                    showMessage(errorContainer, `Could not connect to the prediction service or parse data. Please ensure the Flask server is running and check console for details. Error: ${error.message}`, true);
                } finally {
                    loadingIndicator.style.display = 'none'; // Hide loading indicator regardless of success/failure
                }
            });
        });
    </script>
</body>
</html>

